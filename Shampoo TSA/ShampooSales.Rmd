---
title: "MTH6139 Time Series"
subtitle: "Coursework 1"
author: 
- name: Jibriel Yahya, 210066964 # replace this by your name
date: "March 2024"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri("QMlogo.png"), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; width:30%;')
```

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## 1. Introduction <a id="section-1"></a>

<center>
![](shampoo.jpg)
</center>

<br/>
For this coursework, I found a dataset tracking shampoo sales over a three-year period, analysing the potential insights it could offer. My main aim was to identify any discernible trends within the data, particularly regarding seasonal variations, and use the information to improve sales for businesses. I was also interested to see if it would support my initial hypotheses - sales peaking during the summer months when scalp dryness is more prevalent, and experiencing a slight surge during the holiday season in December, attributed to the tradition of gifting bath sets and toiletries. 
<br/>

### 1.1 Processing Data
<br/>
The first step in the analysis was to load the data in. This is shown below:


```{r}

# Assigning the date values to the variable 'months'
months <- c('1-01-1995', '1-02-1995', '1-03-1995', '1-04-1995', '1-05-1995', '1-06-1995', '1-07-1995', '1-08-1995', '1-09-1995', '1-10-1995', '1-11-1995', '1-12-1995',
            '2-01-1996', '2-02-1996', '2-03-1996', '2-04-1996', '2-05-1996', '2-06-1996', '2-07-1996', '2-08-1996', '2-09-1996', '2-10-1996', '2-11-1996', '2-12-1996',
            '3-01-1997', '3-02-1997', '3-03-1997', '3-04-1997', '3-05-1997', '3-06-1997', '3-07-1997', '3-08-1997', '3-09-1997', '3-10-1997', '3-11-1997', '3-12-1997')

# Assigning the sales values to the variable 'sales'
sales <- c(266.0, 145.9, 183.1, 119.3, 180.3, 168.5, 231.8, 224.5, 192.8, 122.9, 336.5, 185.9,
           194.3, 149.5, 210.1, 273.3, 191.4, 287.0, 226.0, 303.6, 289.9, 421.6, 264.5, 342.3,
           339.7, 440.4, 315.9, 439.3, 401.3, 437.4, 575.5, 407.6, 682.0, 475.3, 581.3, 646.9)
```

Here, I assigned the date values to the variable `months`, and the sales numbers to the variable `sales`. After this, I formatted the 'months' variable using the `as.Date` function to  convert the character strings into dates. This was so that the r code would recognise the month values as dates and not strings, allowing for a plot to be generated of the sales against months.

```{r}
months = as.Date(months, format = "%d-%m-%Y") #formatting the dates

plot(months,sales, main = "Shampoo Sales") #generating the plot

```

Here we see a plot of sales against months. From an initial observation, there is an observable positive trend suggesting that as length of time increases, so does the sales of shampoo. However, to analyse if there is a significant linear relationship, a linear regression will have to be performed.

### 1.2 Linear Regression Analysis
<br/>

For this section, I first generated a linear model of the two variables `sales` and `months` using the `lm` function. 

```{r}
model <- lm(sales ~ months)

```

The next section of code was used to generate a 95% confidence interval around the line of best fit. This was to assess the initial trend of the data.

```{r}

shape <- coef(model)["x"]
scale <- coef(model)["(Intercept)"]
predicted_means <- predict(model, type = "response", se.fit = TRUE)
means <- predicted_means$fit
se <- predicted_means$se.fit

plot(months,sales, main = "Shampoo Sales") 
lines(months, means, col = 'red', lw = 2) #line of best fit

# 95% Confidence Intervals
lines(months, means + 1.96 * se, col = 'blue', lty = 2)
lines(months, means - 1.96 * se, col = 'blue', lty = 2)

```

Within the lower time dates â€” specifically from 1995 to approximately 1997 - the 95% confidence intervals appear to closely flank the regression line. This tight band around the regression line suggests a high degree of certainty in the estimated mean sales for a given time within this range. The convergence of the confidence intervals around the regression line indicates a more predictable, linear relationship.
Contrastingly, beyond 1997, the confidence intervals diverge. This divergence signals increasing uncertainty in the mean sales predictions as time increases. Also, the dispersion of data points outside of these intervals highlights the potential inadequacy of a single linear model.

Looking at the summary of the linear model, we have: 

```{r}
summary(model)

```

The linear regression output suggests that the intercept (B0hat) and the coefficient for months (B1hat) are both highly statistically significant, with p-values well below 0.001 (shown by the triple asterisks). This statistical significance provides strong evidence against the null hypothesis of no relationship.

The model's R-squared value of 0.7301 shows that approximately 73.01% of the variability in shampoo sales is explained by the number of months, suggesting a strong linear relationship. However, an Adjusted R-squared of 0.7222 takes into account the number of predictors in the model, indicating that around 72.22% of the variance is accounted for by the model.

After analysing the residuals and qqplots, we have significant evidence to accept that a linear model should fit the data - that there is a linear relationship between shampoo sales and time from 1995 to 1998.


## 2. Time Series Analysis <a id="section-1"></a>
<br/>

In this section we will be using time series analysis to delve deeper into the dataset, attempting to   show trends and patterns that can offer valuable insights, and facilitate informed conclusions. Through the analysis, we aim to find the underlying dynamics in the data, potentially illuminating actionable strategies.

### 2.1 Initial Analysis

<br/>
For the time series analysis, we convert the `sales` variable into a time series. This is so that the `decomposition()` function can be applied to it, and we can see what the 'observed', 'trend', 'seasonal' and 'random' decompositions show us.

```{r}
sales_ts <- ts(sales, frequency = 12, start = c(1995, 1)) #conversion to a time series

#Decomposing and plotting the time series
model0 <- decompose(sales_ts)
plot(model0)

```

From the observed panel, we can see the sales values over time. It appears there is a general upward trend with some fluctuations that may indicate seasonal patterns or other cyclical variations. Looking at the trend component, it shows a clear upward trajectory over the time frame from 1995 to 1998, showing that there is a general increase in shampoo sales over the specific years. This could be due to various factors such as a growth in customer base, an increase in successful marketing or other factors. 

The seasonal component shows regular patterns within each year, suggesting that shampoo sales experience some form of seasonality. This might be due to seasonal variations in consumer buying behavior, such as increased purchases during certain periods such as in the summer and winter due to holidays or promotions. The last panel displays the residual error or noise from the time series - the variability in this component might be attributed to unusual events or other unmeasured factors affecting shampoo sales.

### 2.2 Holt-Winters Method
<br/>

For this section we will be applying the Holt-Winters method. This is a technique used for forecasting time series data that contains a trend and a seasonal component. The purpose of applying Holt-Winters filtering to the time series of shampoo sales is to capture the general trend of sales over time and to model the cyclical patterns that repeat over the months.

Here we will use the `HoltWinters` function from the `forecast` package to generate our plot of the Holt-Winters filter:

```{r}
#holt-winters method
#library("forecast")
hw0 = HoltWinters(sales_ts)
plot(hw0)

```


Here we see a black line, representing the actual observed shampoo sales over time. The red line is the fitted line produced by the Holt-Winters filtering technique. The purpose of the red line is to smooth out the residual error (noise) and to see the underlying trend and seasonal patterns in the data. The fit seems to track the actual data reasonably well, confirming that the model can capture the trend and seasonality. 

Prior to examining the sales data, I had hypothesised that the peak sales would occur twice annually, with the highest during the summer months. Contrary to this expectation, the data revealed a consistent annual peak around November. This cyclical pattern may be attributed to a delayed response - as people experience dry scalps from the summer's heat, there is a latency before the effects become noticeable. As a result, the demand for shampoo surges just after August. Additionally, the surge in November sales could be amplified by the increase of holiday promotions and the Christmas shopping season, which traditionally boosts retail activity. These factors combined appear to drive a significant increase in shampoo purchases during this period.

I then used the Holt-Winters method to predict a period of 12 months ahead. This is shown below:

```{r}
#holt winters predict
hw1.pred <- predict(hw0, 12)
plot (hw0 , hw1.pred)

```


Beyond the dashed vertical line, the red line extends without the accompanying observed data. This section represents the 12-month forecast produced by the `HoltWinters()` predict function, with the model predicting a continuation of the upward trend in sales. From the forecast we see the increasing trend in shampoo sales is expected to continue into the next year, depicted by the red line's consistent upward trajectory after the dashed line. This forecast is based on the assumption that past sales trends and seasonal patterns will continue into the future without major changes. This expected increase in sales is important to businesses - it could suggest scaling up production or increasing stock in anticipation of higher demand.

### 2.3 Meta's Forecasting System.
<br/>

<center>
![](ProphetLogo.png)
</center>

For this section, we will be using Meta's `prophet` package. It is another tool to analyse and forecast time series data. The first step was to install and load the `prophet` package in R.

```{r, echo=TRUE}

#install.packages("prophet")
#library(prophet)

#install.packages("remotes")
#remotes::install_github('facebook/prophet@*release', subdir='R')
```

Here, I tried both methods of installing the `prophet` package. Using the second method, it made me install an additional package to run the latest version of `prophet`. 

Next, I followed the instructions for creating the dataframe in r, labelling the time data as `ds` and the y sales values as `y`. I then ran some `prophet` functions to generate a forecast of the time series.

```{r, echo=TRUE}

#creating a dataframe
df <- data.frame(ds = months, y = sales)

#generating the forecast
timeseries = prophet::prophet(df)
futurevals = prophet::make_future_dataframe(timeseries, periods=12, freq="month")
prediction = predict(timeseries, futurevals)
plot(timeseries,prediction)
```


The plot presents the observed shampoo sales data points as black dots, providing a visual representation of the actual sales over the given time series. The blue line calculated by `prophet` shows the predicted trend based on this historical data. This line indicates an overall increasing trend in shampoo sales from 1995 to the end of 1998. Specifically, the slope of the blue line appears to steepen as time progresses, suggesting that the rate of increase in sales might be accelerating.

The shaded blue area around the line represents the uncertainty interval of the forecast, with an 80% prediction interval. Here, the uncertainty seems to increase slightly as we move forward in time, which is expected since forecasts become less certain the further they are projected into the future.

Analysing the density and dispersion of the black points around the blue line provides insights into the volatility of sales. Periods where the points closely hug the trend line show consistency and low variability, while wider spreads might point to fluctuations in sales that could stem from numerous factors such as market changes and more.

Towards the end of the plot (1998 to 1999), this period is the forecasted future based on the historical data. The model seems to suggest a continuing increase in sales, confirming the trend concluded from previous models. 


### 2.4 Prophet Seasonality Analysis
<br/>

The next function used from `prophet` was its decomposition function, showing us the average trend and seasonality of the dataset. 

```{r, echo=TRUE}

#plotting components of the time series
prophet::prophet_plot_components(timeseries,prediction)

```

In `prophet`'s analysis of the time series data, we can disregard the trend component, as it reinforces the observation that shampoo sales are on the rise and are projected to continue increasing. The focal point lies in the yearly component provided by Prophet, which reveals the yearly seasonality by averaging it across our three years of data. This offers an in-depth understanding of the seasonal variations. Notably, the plot displays three distinct troughs, indicating periods of lowest sales volume around February, August, and November. These periods likely correspond to off-season phases possibly characterised by reduced demand, the absence of promotions, or other factors that are important for businesses to investigate.

A recommendation for businesses could be to capitalise on these low periods by running promotions during these times to stimulate sales. Additionally, there appears to be a secondary, smaller-scale pattern of peaks and troughs in between the primary ones. This could suggest a secondary seasonal influence within the year, potentially influenced by mid-year events or shifts in consumer behavior.

Moreover, there is no clear long-term trend evident in the seasonality, with the amplitude of the seasonal effect remaining relatively stable over the years. This indicates a consistent seasonal behavior in sales without any significant long-term increase or decrease.

Utilising this insight, businesses can anticipate fluctuations in sales throughout the year and make informed decisions regarding inventory management, marketing strategies, and more. These analyses facilitate proactive preparation for peak and off-peak seasons, enabling businesses to devise strategies to maintain shampoo sales during slower periods.




